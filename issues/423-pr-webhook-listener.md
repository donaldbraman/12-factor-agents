# Issue #423: Create PR Webhook Listener for Automatic Reviews

## Description

Implement a webhook listener that automatically triggers PRReviewAgent when new pull requests are opened or updated in the repository. This will enable fully automated PR reviews without manual intervention.

## Objectives

1. Create webhook listener service
2. Auto-generate issue files for new PRs
3. Integrate with Sparky (IssueOrchestratorAgent)
4. Add GitHub Actions workflow option
5. Support multiple trigger events

## Technical Requirements

### 1. Webhook Listener (`bin/pr-webhook-listener.py`)

```python
#!/usr/bin/env uv run python
"""
PR Webhook Listener - Automatically triggers PR reviews
"""

import json
import hmac
import hashlib
from flask import Flask, request, jsonify
from pathlib import Path
import subprocess
import os

app = Flask(__name__)

def verify_github_signature(payload, signature):
    """Verify webhook came from GitHub"""
    secret = os.getenv("GITHUB_WEBHOOK_SECRET", "").encode()
    expected = hmac.new(secret, payload, hashlib.sha256).hexdigest()
    return hmac.compare_digest(f"sha256={expected}", signature)

@app.route('/webhook', methods=['POST'])
def handle_webhook():
    # Verify signature
    signature = request.headers.get('X-Hub-Signature-256')
    if not verify_github_signature(request.data, signature):
        return jsonify({"error": "Invalid signature"}), 401
    
    # Parse event
    event_type = request.headers.get('X-GitHub-Event')
    payload = request.json
    
    if event_type == 'pull_request':
        action = payload.get('action')
        if action in ['opened', 'synchronize', 'reopened']:
            pr = payload['pull_request']
            create_pr_review_issue(pr)
            trigger_sparky()
    
    return jsonify({"status": "processed"}), 200

def create_pr_review_issue(pr):
    """Create issue file for PR review"""
    issue_number = 500 + pr['number']  # Offset to avoid conflicts
    issue_path = Path(f"issues/{issue_number}-review-pr-{pr['number']}.md")
    
    content = f'''# Issue #{issue_number}: Review PR #{pr['number']}

## Description
Automatically review pull request #{pr['number']}: {pr['title']}

## PR Details
- Author: {pr['user']['login']}
- Branch: {pr['head']['ref']} -> {pr['base']['ref']}
- URL: {pr['html_url']}

## Task
Review PR #{pr['number']} and provide feedback

## Agent Assignment
PRReviewAgent

## Priority
High

## Auto-Generated
This issue was automatically generated by PR webhook listener.
'''
    
    issue_path.write_text(content)
    print(f"Created issue {issue_number} for PR #{pr['number']}")

def trigger_sparky():
    """Trigger Sparky to process new issues"""
    subprocess.run(['uv', 'run', 'agent', 'run', 'sparky', 'resolve all issues'])

if __name__ == '__main__':
    port = int(os.getenv('WEBHOOK_PORT', 8080))
    app.run(host='0.0.0.0', port=port)
```

### 2. GitHub Actions Alternative (`.github/workflows/pr-review.yml`)

```yaml
name: Automated PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          
      - name: Install dependencies
        run: |
          uv pip install -r requirements.txt
          
      - name: Run PR Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          uv run agent run PRReviewAgent "review PR #${{ github.event.pull_request.number }}"
```

### 3. Local Development Setup (`scripts/run-webhook-dev.sh`)

```bash
#!/bin/bash
# Development webhook listener with ngrok

# Start listener
python bin/pr-webhook-listener.py &
LISTENER_PID=$!

# Start ngrok tunnel
ngrok http 8080 &
NGROK_PID=$!

echo "Webhook listener running on http://localhost:8080"
echo "Configure GitHub webhook with ngrok URL + /webhook"
echo "Press Ctrl+C to stop"

# Cleanup on exit
trap "kill $LISTENER_PID $NGROK_PID" EXIT
wait
```

### 4. Configuration

Add to `.env`:
```bash
GITHUB_WEBHOOK_SECRET=your_webhook_secret_here
WEBHOOK_PORT=8080
AUTO_REVIEW_ENABLED=true
```

### 5. Setup Instructions

Document in `docs/WEBHOOK_SETUP.md`:

```markdown
## PR Webhook Setup

### Option 1: GitHub Actions (Recommended)
1. Copy `.github/workflows/pr-review.yml` to your repo
2. Add secrets in GitHub Settings:
   - OPENAI_API_KEY or ANTHROPIC_API_KEY
3. PRs will be automatically reviewed

### Option 2: Webhook Listener
1. Run webhook listener:
   ```bash
   python bin/pr-webhook-listener.py
   ```

2. Expose endpoint (production):
   - Deploy to cloud service (Heroku, AWS Lambda, etc.)
   - Or use reverse proxy with SSL

3. Configure GitHub webhook:
   - Go to Settings > Webhooks > Add webhook
   - URL: https://your-domain.com/webhook
   - Content type: application/json
   - Secret: your_webhook_secret
   - Events: Pull requests

### Option 3: Local Development
1. Install ngrok: `brew install ngrok`
2. Run: `./scripts/run-webhook-dev.sh`
3. Configure GitHub with ngrok URL
```

## Success Criteria

- [ ] Webhook listener receives GitHub events
- [ ] Auto-creates issue files for new PRs
- [ ] Triggers Sparky successfully
- [ ] GitHub Actions workflow works
- [ ] Signature verification working
- [ ] Documentation complete

## Agent Assignment

EventSystemAgent

## Priority

Medium

## Dependencies

- Issue #420 (PRReviewAgent implementation)
- Issue #421 (PyGithub setup)
- Flask for webhook server

## Estimated Effort

2-3 hours

## Notes

GitHub Actions is simpler for most users, but webhook listener provides more control and works with self-hosted instances. Both options should be supported.

## Status
RESOLVED

### Resolution Notes
Resolved by EventSystemAgent at 2025-09-15T10:22:23.557260

### Updated: 2025-09-15T10:22:23.557327
